<%- layout("/layouts/boilerplate") %>

<div class="row mt-4">
  <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3">
    <h3>Book <%= listing.title %></h3>
    <br>
    
    <div class="card mb-3">
      <img src="<%= listing.image.url %>" class="card-img-top" alt="<%= listing.title %>" style="height: 300px; object-fit: cover;">
      <div class="card-body">
        <h5 class="card-title"><%= listing.title %></h5>
        <p class="card-text"><%= listing.location %>, <%= listing.country %></p>
        <p class="card-text"><strong>â‚¹<%= listing.price.toLocaleString("en-IN") %></strong> / night</p>
      </div>
    </div>

    <form method="POST" action="/bookings/listings/<%= listing._id %>/book" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="checkIn" class="form-label">Check-in Date</label>
        <input type="date" name="booking[checkIn]" class="form-control" id="checkIn" required>
        <div class="invalid-feedback">Please select a valid check-in date (today or later)</div>
      </div>

      <div class="mb-3">
        <label for="checkOut" class="form-label">Check-out Date</label>
        <input type="date" name="booking[checkOut]" class="form-control" id="checkOut" required>
        <div class="invalid-feedback">Check-out date must be after check-in date</div>
      </div>

      <div class="mb-3">
        <label for="guests" class="form-label">Number of Guests</label>
        <input type="number" name="booking[guests]" class="form-control" id="guests" min="1" max="20" required>
        <div class="invalid-feedback">Please enter number of guests (1-20)</div>
      </div>

      <button type="submit" class="btn btn-success w-100">Submit Booking Request</button>
      <a href="/listings/<%= listing._id %>" class="btn btn-secondary w-100 mt-2">Cancel</a>
    </form>
  </div>
</div>

<script>
  // Set minimum date to today for check-in
  const today = new Date().toISOString().split('T')[0];
  const checkInInput = document.getElementById('checkIn');
  const checkOutInput = document.getElementById('checkOut');
  
  checkInInput.setAttribute('min', today);
  checkOutInput.setAttribute('min', today);
  
  // Update check-out minimum date when check-in changes
  checkInInput.addEventListener('change', function() {
    const checkInDate = new Date(this.value);
    const nextDay = new Date(checkInDate);
    nextDay.setDate(nextDay.getDate() + 1);
    const minCheckOut = nextDay.toISOString().split('T')[0];
    checkOutInput.setAttribute('min', minCheckOut);
    
    // If check-out is before new minimum, clear it
    if (checkOutInput.value && checkOutInput.value <= this.value) {
      checkOutInput.value = '';
    }
  });
  
  // Validate form before submission
  document.querySelector('form').addEventListener('submit', function(e) {
    const checkIn = new Date(checkInInput.value);
    const checkOut = new Date(checkOutInput.value);
    const todayDate = new Date(today);
    
    if (checkIn < todayDate) {
      e.preventDefault();
      alert('Check-in date cannot be in the past!');
      return false;
    }
    
    if (checkOut <= checkIn) {
      e.preventDefault();
      alert('Check-out date must be after check-in date!');
      return false;
    }
  });
</script>

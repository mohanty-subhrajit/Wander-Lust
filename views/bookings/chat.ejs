<%- layout("/layouts/boilerplate") %>

<link rel="stylesheet" href="/css/chat.css">

<div class="container mt-4 mb-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3><i class="fa-solid fa-comments"></i> Chat</h3>
          <p class="text-muted mb-0">
            <strong>Property:</strong> <%= booking.listing.title %><br>
            <small><%= booking.listing.location %>, <%= booking.listing.country %></small><br>
            <strong>Talking with:</strong> <%= otherParticipant.username %>
          </p>
        </div>
        <a href="<%= currentUser._id.equals(booking.customer._id) ? '/bookings/my-bookings' : '/bookings/manage' %>" class="btn btn-secondary">
          <i class="fa-solid fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card chat-card">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="fa-solid fa-user-circle"></i> <%= otherParticipant.username %>
            </div>
            <div>
              <small>
                <i class="fa-solid fa-calendar"></i> 
                <%= new Date(booking.checkIn).toLocaleDateString() %> - 
                <%= new Date(booking.checkOut).toLocaleDateString() %>
              </small>
            </div>
          </div>
        </div>
        
        <div class="card-body chat-messages" id="chatMessages">
          <% if(chat.messages.length === 0) { %>
            <div class="text-center text-muted py-5">
              <i class="fa-solid fa-comment-dots fa-3x mb-3"></i>
              <p>No messages yet. Start the conversation!</p>
            </div>
          <% } else { %>
            <% for(let message of chat.messages) { %>
              <% const isCurrentUser = message.sender._id.equals(currentUser._id); %>
              <div class="message <%= isCurrentUser ? 'message-sent' : 'message-received' %>">
                <div class="message-content">
                  <div class="message-header">
                    <strong><%= message.sender.username %></strong>
                    <small class="text-muted ms-2">
                      <%= new Date(message.timestamp).toLocaleString('en-IN', { 
                        timeZone: 'Asia/Kolkata',
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true
                      }) %>
                    </small>
                  </div>
                  <div class="message-text"><%= message.content %></div>
                </div>
              </div>
            <% } %>
          <% } %>
        </div>
        
        <div class="card-footer">
          <form id="chatForm" class="d-flex gap-2">
            <input 
              type="text" 
              id="messageInput" 
              class="form-control" 
              placeholder="Type your message..." 
              required
              autocomplete="off"
            >
            <button type="submit" class="btn btn-primary" id="sendBtn">
              <i class="fa-solid fa-paper-plane"></i> Send
            </button>
          </form>
          <div id="errorMessage" class="text-danger mt-2" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const bookingId = '<%= booking._id %>';
  const currentUserId = '<%= currentUser._id %>';
  const currentUserName = '<%= currentUser.username %>';
</script>
<script src="/js/chat.js"></script>
